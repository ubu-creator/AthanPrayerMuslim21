<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TowMes - Global Athan</title>
    <link rel="manifest" href="data:application/manifest+json,{'name':'TowMes','short_name':'TowMes','display':'standalone'}" />
    <style>
        :root { --gold: #fbbf24; --white: #f8fafc; --blue-dark: #0f172a; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative; color: white;
        }

        /* --- التحسينات البصرية (سحاب، هلال، كعبة) --- */
        .cloud-container { position: absolute; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .cloud { position: absolute; width: 200px; opacity: 0.25; animation: moveClouds 35s linear infinite; }
        @keyframes moveClouds { from { right: -250px; } to { right: 110vw; } }
        .moon { position: absolute; top: 20px; right: 20px; width: 70px; filter: drop-shadow(0 0 15px var(--gold)); z-index: 1; }
        .kaaba { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; opacity: 0.2; z-index: 0; pointer-events: none; }

        /* --- واجهة التطبيق الزجاجية --- */
        .app-container {
            position: relative; background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(15px);
            padding: 2rem; border-radius: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            width: 90%; max-width: 400px; text-align: center; z-index: 10;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        .brand { font-size: 1.8rem; font-weight: bold; color: var(--gold); letter-spacing: 3px; margin-bottom: 5px; }
        .clock { font-size: 3.8rem; font-weight: bold; color: var(--gold); text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
        .date { font-size: 1rem; color: #94a3b8; margin-bottom: 20px; }

        /* --- قائمة أوقات الصلاة (عربي + إنجليزي) --- */
        .prayer-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; margin: 10px 0; background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; border: 1px solid transparent; transition: 0.3s;
        }
        .active-prayer { border-color: var(--gold); background: rgba(251, 191, 36, 0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); } }
        .p-name { font-size: 1.1rem; font-weight: 600; }
        .p-name span { font-size: 0.8rem; color: #64748b; margin-right: 8px; }

        /* --- التحكم والإعدادات --- */
        select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; }
        select { background: #334155; color: white; outline: none; }
        button { background: var(--gold); color: #0f172a; font-size: 1rem; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
        .status { font-size: 0.75rem; color: #94a3b8; margin-top: 12px; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="cloud-container">
        <img src="https://www.pngmart.com/files/15/Vector-Cloud-PNG-Transparent-Image.png" class="cloud" style="top:5%; animation-duration: 40s;">
        <img src="https://www.pngmart.com/files/15/Vector-Cloud-PNG-Transparent-Image.png" class="cloud" style="top:25%; animation-duration: 25s;">
    </div>

    <img src="https://cdn-icons-png.flaticon.com/512/1823/1823330.png" class="moon" alt="Crescent">
    <img src="https://pngimg.com/d/kaaba_PNG10.png" class="kaaba" alt="Kaaba">

    <div class="app-container">
        <div class="brand">TowMes</div>
        <div class="clock" id="time">00:00</div>
        <div class="date" id="date">جاري التحميل...</div>

        <div id="prayer-list"></div>

        <select id="voice-select" onchange="updateAudioSource()">
            <option value="https://www.islamcan.com/audio/adhan/azan1.mp3">عبد الباسط عبد الصمد</option>
            <option value="https://www.islamcan.com/audio/adhan/azan5.mp3">محمد صديق المنشاوي</option>
            <option value="https://www.islamcan.com/audio/adhan/azan3.mp3">مشاري العفاسي</option>
            <option value="https://www.islamcan.com/audio/adhan/azan4.mp3">سعد الغامدي</option>
            <option value="https://www.islamcan.com/audio/adhan/azan6.mp3">عمر الكزبري</option>
        </select>

        <select id="method-select" onchange="initApp()" style="margin-top:5px;">
            <option value="4">رابطة العالم الإسلامي (أم القرى)</option>
            <option value="2">الجمعية الإسلامية لأمريكا الشمالية</option>
            <option value="3">الهيئة المصرية العامة للمساحة</option>
            <option value="1">جامعة العلوم الإسلامية بكراتشي</option>
        </select>

        <button id="btn-act">تفعيل الأذان التلقائي</button>
        <div class="status" id="status">انقر في أي مكان لتفعيل الصوت</div>
        <div class="status" id="loc-info" style="font-size:0.65rem">جاري تحديد الموقع...</div>
    </div>

    <script>
        let audio = new Audio();
        let prayers = {};
        let isUnlocked = false;

        async function initApp() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => fetchTimes(pos.coords.latitude, pos.coords.longitude),
                    () => fetchTimes(21.4225, 39.8262) // مكة المكرمة كخيار احتياطي
                );
            }
        }

        async function fetchTimes(lat, lng) {
            const method = document.getElementById('method-select').value;
            document.getElementById('loc-info').innerText = `الموقع: ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
            const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=${method}`);
            const data = await res.json();
            prayers = data.data.timings;
            document.getElementById('date').innerText = data.data.date.readable + " | " + data.data.date.hijri.day + " " + data.data.date.hijri.month.ar;
            renderUI();
        }

        function renderUI() {
            const listNames = { 'Fajr':'الفجر', 'Dhuhr':'الظهر', 'Asr':'العصر', 'Maghrib':'المغرب', 'Isha':'العشاء' };
            const container = document.getElementById('prayer-list');
            container.innerHTML = '';
            Object.keys(listNames).forEach(p => {
                container.innerHTML += `
                    <div class="prayer-row" id="row-${p}">
                        <div class="p-name">${listNames[p]} <span>${p}</span></div>
                        <div style="color:var(--gold); font-weight:bold; font-size:1.2rem;">${prayers[p]}</div>
                    </div>
                `;
            });
        }

        function unlockAudio() {
            if(!isUnlocked) {
                audio.src = document.getElementById('voice-select').value;
                audio.play().then(() => {
                    audio.pause();
                    isUnlocked = true;
                    document.getElementById('status').innerText = "✅ النظام يعمل تلقائياً";
                    document.getElementById('btn-act').style.display = 'none';
                });
            }
        }

        function updateAudioSource() {
            audio.src = document.getElementById('voice-select').value;
            audio.load();
        }

        function checkTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});

            ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(p => {
                const el = document.getElementById(`row-${p}`);
                if (prayers[p] === timeStr) {
                    if (isUnlocked) {
                        audio.play().catch(() => {});
                        isUnlocked = false; 
                        setTimeout(() => isUnlocked = true, 61000);
                    }
                    if(el) el.classList.add('active-prayer');
                } else {
                    if(el) el.classList.remove('active-prayer');
                }
            });
        }

        setInterval(checkTime, 1000);
        window.onload = initApp;
    </script>
</body>
</html>
